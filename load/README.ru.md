# –ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Vegeta

[üá∑üá∫ –†—É—Å—Å–∫–∏–π](README.ru.md) | [üá¨üáß English](README.md)

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É [Vegeta](https://github.com/tsenart/vegeta) –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ä–µ–≤—å—é–≤–µ—Ä–æ–≤. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –∫–∞–∫ Go-–ø—Ä–æ–≥—Ä–∞–º–º–∞ –≤ `load/cli/`.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)
- [–°—Ç—Ä—É–∫—Ç—É—Ä–∞](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
- [–ü–∞—Ä–∞–º–µ—Ç—Ä—ã](#–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
  - [–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–ª–∞–≥–∏](#–¥–æ—Å—Ç—É–ø–Ω—ã–µ-—Ñ–ª–∞–≥–∏)
  - [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
- [–ö–æ–º–∞–Ω–¥—ã Makefile](#–∫–æ–º–∞–Ω–¥—ã-makefile)
- [–°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è](#—Å—Ü–µ–Ω–∞—Ä–∏–π-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- [–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤](#–∞–Ω–∞–ª–∏–∑-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
  - [–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç](#—Ç–µ–∫—Å—Ç–æ–≤—ã–π-–æ—Ç—á—ë—Ç)
  - [HTML –≥—Ä–∞—Ñ–∏–∫](#html-–≥—Ä–∞—Ñ–∏–∫)
  - [–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ JSON](#–¥–µ—Ç–∞–ª—å–Ω–∞—è-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞-–≤-json)
- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è SLA](#—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è-sla)

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å:
   ```bash
   docker compose up --build
   ```

2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   ```bash
   make load-test
   ```

   –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é:
   ```bash
   go run ./load/cli
   ```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

- `load/cli/` ‚Äî Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  - `main.go` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–¥ (setup, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤, –∑–∞–ø—É—Å–∫ Vegeta)
  - `main_test.go` ‚Äî unit —Ç–µ—Å—Ç—ã
- `load/scripts/` ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ shell-—Å–∫—Ä–∏–ø—Ç—ã (—É—Å—Ç–∞—Ä–µ–≤—à–∏–µ, –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏)
  - `setup.sh` ‚Äî –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
  - `load_test.sh` ‚Äî –∑–∞–ø—É—Å–∫ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
  - `generate_targets.sh` ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è targets –¥–ª—è Vegeta
- `load/artifacts/` ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —Ç–µ—Å—Ç–æ–≤
  - `results.bin` ‚Äî –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–∞
  - `plot.html` ‚Äî HTML –≥—Ä–∞—Ñ–∏–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ)
  - `vegeta-plot.png` ‚Äî –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–µ—Ä–µ–∑ —Ñ–ª–∞–≥–∏ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏:

```bash
go run ./load/cli -url=http://localhost:8080 -rate=5 -duration=60s -team=load-team
```

### –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–ª–∞–≥–∏

| –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|------|----------|----------------------|
| `-url` | Base URL —Å–µ—Ä–≤–∏—Å–∞ | `http://localhost:8080` |
| `-rate` | –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É | `5` |
| `-duration` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç–µ—Å—Ç–∞ | `60s` |
| `-team` | –ò–º—è —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–∞–Ω–¥—ã | `load-team` |
| `-setup-only` | –¢–æ–ª—å–∫–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã) | `false` |
| `-report` | –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á—ë—Ç –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | `false` |
| `-plot` | –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ | `false` |

### –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```bash
# –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
go run ./load/cli -rate=10 -duration=30s

# –¢–æ–ª—å–∫–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
go run ./load/cli -setup-only

# –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á—ë—Ç –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
go run ./load/cli -report

# –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞
go run ./load/cli -plot
```

## –ö–æ–º–∞–Ω–¥—ã Makefile

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `make load-test` | –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (setup + –Ω–∞–≥—Ä—É–∑–∫–∞) |
| `make load-test-setup` | –¢–æ–ª—å–∫–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã) |
| `make load-test-report` | –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç—á—ë—Ç –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ |
| `make load-test-plot` | –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞ |

## –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–æ–º–∞–Ω–¥–∞ `load-team` —Å —Ç—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:
   - `lu1` ‚Äî Load Alice
   - `lu2` ‚Äî Load Bob
   - `lu3` ‚Äî Load Carol

2. **–ù–∞–≥—Ä—É–∑–∫–∞**: Vegeta –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ `/pullRequest/create` —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ ID (–≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ `time.Now().UnixNano()` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–∑–Ω–∞—á–∞—é—Ç—Å—è —Ä–µ–≤—å—é–≤–µ—Ä—ã –∏–∑ –∫–æ–º–∞–Ω–¥—ã –∞–≤—Ç–æ—Ä–∞ (–¥–æ 2 —à—Ç—É–∫)

## –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `load/artifacts/results.bin`. –î–ª—è –∞–Ω–∞–ª–∏–∑–∞:

### –¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç

```bash
# –ß–µ—Ä–µ–∑ Go-–ø—Ä–æ–≥—Ä–∞–º–º—É
go run ./load/cli -report

# –ò–ª–∏ —á–µ—Ä–µ–∑ CLI —É—Ç–∏–ª–∏—Ç—É vegeta (–µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
vegeta report load/artifacts/results.bin
```

### HTML –≥—Ä–∞—Ñ–∏–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å CLI —É—Ç–∏–ª–∏—Ç—É vegeta
go install github.com/tsenart/vegeta/v12@latest

# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫
vegeta plot load/artifacts/results.bin > load/artifacts/plot.html

# –û—Ç–∫—Ä—ã—Ç—å –≤ –±—Ä–∞—É–∑–µ—Ä–µ
open load/artifacts/plot.html  # macOS
xdg-open load/artifacts/plot.html  # Linux
```

### –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ JSON

```bash
vegeta report -type=json load/artifacts/results.bin | jq
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è SLA

–°–æ–≥–ª–∞—Å–Ω–æ –¢–ó:
- **RPS**: 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
- **SLI –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞**: 300 –º—Å (95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
- **SLI —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏**: 99.9%

Vegeta –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ç–∏ –º–µ—Ç—Ä–∏–∫–∏ –∏ –≤—ã–≤–æ–¥–∏—Ç –æ—Ç—á—ë—Ç. –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–º. –≤ [–æ—Ç—á—ë—Ç–µ –ø–æ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–º—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é](load-test-report.ru.md).

